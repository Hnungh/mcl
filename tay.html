<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DigiCam - Digital Camera App</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      overflow: hidden;
      touch-action: manipulation;
    }

    html, body {
      height: 100%;
      position: fixed;
      width: 100%;
    }

    .camera-container {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      background: #000;
    }

    .camera-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      padding: 16px 20px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      color: #c4b5fd;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .header-info {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .info-badge {
      background: rgba(196, 181, 253, 0.2);
      color: #c4b5fd;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .video-container {
      flex: 1;
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    #videoElement {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #canvas {
      display: none;
    }

    .filter-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    /* Filter Styles */
    .filter-none { filter: none; }
    .filter-canon-430 { 
      filter: contrast(1.15) saturate(1.2) brightness(1.05) sepia(0.08);
    }
    .filter-canon-180 { 
      filter: contrast(1.1) saturate(0.95) brightness(1.1) hue-rotate(-5deg);
    }
    .filter-sony-cyber { 
      filter: contrast(1.25) saturate(1.4) brightness(0.95) hue-rotate(5deg);
    }
    .filter-samsung-classic { 
      filter: contrast(1.05) saturate(0.85) brightness(1.08) sepia(0.15);
    }

    .controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      padding: 20px;
      background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0) 100%);
    }

    .filter-selector {
      margin-bottom: 24px;
      padding: 0 10px;
    }

    .filter-label {
      color: #a78bfa;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      display: block;
      text-align: center;
    }

    .filter-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
      scrollbar-width: thin;
      scrollbar-color: #6b7280 transparent;
    }

    .filter-scroll::-webkit-scrollbar {
      height: 4px;
    }

    .filter-scroll::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
    }

    .filter-scroll::-webkit-scrollbar-thumb {
      background: #6b7280;
      border-radius: 2px;
    }

    .filter-btn {
      flex-shrink: 0;
      padding: 10px 18px;
      background: rgba(55, 65, 81, 0.8);
      border: 2px solid transparent;
      border-radius: 20px;
      color: #d1d5db;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      backdrop-filter: blur(10px);
    }

    .filter-btn:hover {
      background: rgba(75, 85, 99, 0.9);
      border-color: #9ca3af;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
      border-color: #c4b5fd;
      color: #1a1a1a;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
    }

    .main-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .side-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .control-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 2px solid rgba(156, 163, 175, 0.5);
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #d1d5db;
      font-size: 22px;
      position: relative;
    }

    .control-btn:hover {
      background: rgba(55, 65, 81, 0.95);
      border-color: #9ca3af;
      transform: scale(1.05);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn.flash-on {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-color: #fbbf24;
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    .capture-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%);
      border: 4px solid rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(167, 139, 250, 0.5);
      position: relative;
    }

    .capture-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 8px 24px rgba(167, 139, 250, 0.7);
    }

    .capture-btn:active {
      transform: scale(0.95);
    }

    .capture-icon {
      font-size: 32px;
      color: #1a1a1a;
      margin-bottom: 2px;
    }

    .capture-label {
      font-size: 9px;
      font-weight: 700;
      color: #1a1a1a;
      letter-spacing: 0.5px;
    }

    .flash-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 30;
      transition: opacity 0.1s ease;
    }

    .flash-effect.active {
      opacity: 0.9;
    }

    .toast {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(0, 0, 0, 0.9);
      color: #c4b5fd;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      border: 1px solid rgba(196, 181, 253, 0.3);
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .permission-content {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      padding: 32px 28px;
      border-radius: 24px;
      max-width: 380px;
      text-align: center;
      border: 2px solid rgba(196, 181, 253, 0.2);
    }

    .permission-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .permission-title {
      font-size: 22px;
      font-weight: 700;
      color: #c4b5fd;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .permission-text {
      font-size: 15px;
      color: #d1d5db;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .permission-btn {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
      border: none;
      border-radius: 16px;
      color: #1a1a1a;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .permission-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(167, 139, 250, 0.5);
    }

    .permission-btn:active {
      transform: translateY(0);
    }

    .error-text {
      color: #fca5a5;
      margin-top: 12px;
      font-size: 13px;
    }

    .gallery-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.98);
      z-index: 45;
      display: none;
      flex-direction: column;
    }

    .gallery-modal.show {
      display: flex;
    }

    .gallery-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
    }

    .gallery-title {
      font-size: 18px;
      font-weight: 600;
      color: #c4b5fd;
      letter-spacing: 1px;
    }

    .close-gallery-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(55, 65, 81, 0.8);
      border: none;
      color: #d1d5db;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-gallery-btn:hover {
      background: rgba(75, 85, 99, 0.9);
      transform: scale(1.1);
    }

    .gallery-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      align-content: start;
    }

    .gallery-item {
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid rgba(196, 181, 253, 0.2);
      transition: all 0.3s ease;
      position: relative;
    }

    .gallery-item:hover {
      border-color: #a78bfa;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .gallery-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .gallery-empty-text {
      font-size: 16px;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .camera-header {
        padding: 12px 16px;
      }

      .app-title {
        font-size: 16px;
      }

      .info-badge {
        font-size: 10px;
        padding: 3px 8px;
      }

      .control-btn {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .capture-btn {
        width: 70px;
        height: 70px;
      }

      .capture-icon {
        font-size: 28px;
      }

      .filter-btn {
        padding: 8px 14px;
        font-size: 12px;
      }

      .gallery-content {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #c4b5fd;
      font-size: 48px;
      animation: spin 1s linear infinite;
      z-index: 5;
    }

    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="camera-container"><!-- Permission Modal -->
   <div id="permissionModal" class="permission-modal">
    <div class="permission-content">
     <div class="permission-icon">
      üì∑
     </div>
     <div class="permission-title" id="permissionTitle">
      Camera Access Required
     </div>
     <div class="permission-text" id="permissionText">
      This app needs access to your camera to take photos. Please allow camera permission to continue.
     </div><button class="permission-btn" id="enableCameraBtn">Enable Camera</button>
     <div id="errorText" class="error-text" style="display: none;"></div>
    </div>
   </div><!-- Camera Header -->
   <header class="camera-header">
    <div class="app-title" id="appTitle">
     DIGICAM
    </div>
    <div class="header-info"><span class="info-badge" id="filterBadge">No Filter</span> <span class="info-badge" id="resolutionBadge">HD</span>
    </div>
   </header><!-- Video Container -->
   <div class="video-container">
    <div class="loading-spinner" id="loadingSpinner">
     ‚öôÔ∏è
    </div>
    <video id="videoElement" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div class="filter-overlay" id="filterOverlay"></div>
    <div class="flash-effect" id="flashEffect"></div>
   </div><!-- Controls -->
   <div class="controls-overlay"><!-- Filter Selector -->
    <div class="filter-selector"><label class="filter-label">Digital Camera Filters</label>
     <div class="filter-scroll" id="filterScroll"><button class="filter-btn active" data-filter="none">None</button> <button class="filter-btn" data-filter="canon-430">Canon IXY 430</button> <button class="filter-btn" data-filter="canon-180">Canon IXY 180</button> <button class="filter-btn" data-filter="sony-cyber">Sony CyberShot</button> <button class="filter-btn" data-filter="samsung-classic">Samsung Classic</button>
     </div>
    </div><!-- Main Controls -->
    <div class="main-controls">
     <div class="side-controls"><button class="control-btn" id="switchCameraBtn" title="Switch Camera">üîÑ</button> <button class="control-btn" id="flashBtn" title="Flash">‚ö°</button>
     </div><button class="capture-btn" id="captureBtn">
      <div class="capture-icon">
       üì∑
      </div>
      <div class="capture-label" id="captureLabel">
       CAPTURE
      </div></button>
     <div class="side-controls"><button class="control-btn" id="galleryBtn" title="Gallery">üñºÔ∏è</button>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div class="toast" id="toast"></div><!-- Gallery Modal -->
   <div class="gallery-modal" id="galleryModal">
    <div class="gallery-header">
     <div class="gallery-title">
      üì∏ Captured Photos
     </div><button class="close-gallery-btn" id="closeGalleryBtn">√ó</button>
    </div>
    <div class="gallery-content" id="galleryContent">
     <div class="gallery-empty">
      <div class="gallery-empty-icon">
       üì∑
      </div>
      <div class="gallery-empty-text">
       No photos yet. Start capturing!
      </div>
     </div>
    </div>
   </div>
  </main>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: "DIGICAM",
      capture_button_text: "CAPTURE",
      background_color: "#000000",
      primary_color: "#c4b5fd",
      secondary_color: "#a78bfa",
      text_color: "#d1d5db",
      accent_color: "#1f2937"
    };

    // Camera State
    let stream = null;
    let currentFilter = 'none';
    let flashEnabled = false;
    let currentCamera = 'user'; // 'user' for front, 'environment' for back
    let capturedPhotos = [];
    let videoElement, canvas, ctx;

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      videoElement = document.getElementById('videoElement');
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      setupEventListeners();
      showPermissionModal();

      // Initialize Element SDK
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: handleConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  window.elementSdk.config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => {
                  window.elementSdk.config.secondary_color = value;
                  window.elementSdk.setConfig({ secondary_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  window.elementSdk.config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  window.elementSdk.config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              },
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  window.elementSdk.config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["capture_button_text", config.capture_button_text || defaultConfig.capture_button_text]
          ])
        });

        handleConfigChange(window.elementSdk.config);
      }
    }

    async function handleConfigChange(config) {
      const appTitle = document.getElementById('appTitle');
      const captureLabel = document.getElementById('captureLabel');
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const backgroundColor = config.background_color || defaultConfig.background_color;

      if (appTitle) appTitle.textContent = config.app_title || defaultConfig.app_title;
      if (captureLabel) captureLabel.textContent = config.capture_button_text || defaultConfig.capture_button_text;

      // Apply colors
      document.documentElement.style.setProperty('--primary-color', primaryColor);
      document.documentElement.style.setProperty('--secondary-color', secondaryColor);
      document.documentElement.style.setProperty('--text-color', textColor);
      document.documentElement.style.setProperty('--accent-color', accentColor);
      document.documentElement.style.setProperty('--bg-color', backgroundColor);

      // Update UI elements with colors
      const appTitleEl = document.querySelector('.app-title');
      if (appTitleEl) appTitleEl.style.color = primaryColor;

      const infoBadges = document.querySelectorAll('.info-badge');
      infoBadges.forEach(badge => {
        badge.style.backgroundColor = `${primaryColor}33`;
        badge.style.color = primaryColor;
      });

      const captureBtn = document.querySelector('.capture-btn');
      if (captureBtn) {
        captureBtn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
      }

      const filterBtns = document.querySelectorAll('.filter-btn.active');
      filterBtns.forEach(btn => {
        btn.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${primaryColor} 100%)`;
        btn.style.borderColor = primaryColor;
      });

      const permissionTitle = document.querySelector('.permission-title');
      if (permissionTitle) permissionTitle.style.color = primaryColor;

      const galleryTitle = document.querySelector('.gallery-title');
      if (galleryTitle) galleryTitle.style.color = primaryColor;

      const videoContainer = document.querySelector('.video-container');
      if (videoContainer) videoContainer.style.backgroundColor = backgroundColor;
    }

    function setupEventListeners() {
      document.getElementById('enableCameraBtn').addEventListener('click', requestCameraPermission);
      document.getElementById('captureBtn').addEventListener('click', capturePhoto);
      document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
      document.getElementById('flashBtn').addEventListener('click', toggleFlash);
      document.getElementById('galleryBtn').addEventListener('click', openGallery);
      document.getElementById('closeGalleryBtn').addEventListener('click', closeGallery);

      // Filter buttons
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          applyFilter(filter);
          
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    function showPermissionModal() {
      document.getElementById('permissionModal').style.display = 'flex';
    }

    function hidePermissionModal() {
      document.getElementById('permissionModal').style.display = 'none';
    }

    async function requestCameraPermission() {
      try {
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        
        videoElement.addEventListener('loadedmetadata', () => {
          document.getElementById('loadingSpinner').style.display = 'none';
          updateResolutionBadge();
        });

        hidePermissionModal();
        showToast('Camera ready! üì∑');
      } catch (error) {
        console.error('Camera error:', error);
        document.getElementById('errorText').textContent = 
          'Unable to access camera. Please check permissions.';
        document.getElementById('errorText').style.display = 'block';
      }
    }

    async function switchCamera() {
      if (!stream) return;

      currentCamera = currentCamera === 'user' ? 'environment' : 'user';
      
      stream.getTracks().forEach(track => track.stop());
      
      try {
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        
        showToast(currentCamera === 'user' ? 'Front Camera ü§≥' : 'Back Camera üì∏');
        updateResolutionBadge();
      } catch (error) {
        console.error('Switch camera error:', error);
        showToast('Cannot switch camera');
      }
    }

    function toggleFlash() {
      flashEnabled = !flashEnabled;
      const flashBtn = document.getElementById('flashBtn');
      
      if (flashEnabled) {
        flashBtn.classList.add('flash-on');
        showToast('Flash enabled ‚ö°');
      } else {
        flashBtn.classList.remove('flash-on');
        showToast('Flash disabled');
      }
    }

    function applyFilter(filterName) {
      currentFilter = filterName;
      const videoContainer = document.querySelector('.video-container');
      
      videoContainer.className = 'video-container';
      
      if (filterName !== 'none') {
        videoElement.classList.add(`filter-${filterName}`);
      } else {
        videoElement.className = '';
      }
      
      document.getElementById('filterBadge').textContent = 
        filterName === 'none' ? 'No Filter' : 
        filterName === 'canon-430' ? 'Canon 430' :
        filterName === 'canon-180' ? 'Canon 180' :
        filterName === 'sony-cyber' ? 'Sony Cyber' :
        'Samsung Classic';
    }

    async function capturePhoto() {
      if (!stream) {
        showToast('Camera not ready');
        return;
      }

      // Flash effect
      if (flashEnabled) {
        const flashEffect = document.getElementById('flashEffect');
        flashEffect.classList.add('active');
        setTimeout(() => flashEffect.classList.remove('active'), 100);
      }

      // Capture from video
      canvas.width = videoElement.videoWidth || 1920;
      canvas.height = videoElement.videoHeight || 1080;
      
      ctx.filter = getComputedStyle(videoElement).filter || 'none';
      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
      
      // Convert to high quality JPEG
      const dataUrl = canvas.toDataURL('image/jpeg', 1.0);
      
      // Save to gallery
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      const photo = {
        id: Date.now(),
        dataUrl: dataUrl,
        timestamp: timestamp,
        filter: currentFilter
      };
      
      capturedPhotos.unshift(photo);
      
      // Download file
      const link = document.createElement('a');
      link.download = `DigiCam_${timestamp}.jpg`;
      link.href = dataUrl;
      link.click();
      
      showToast('Photo saved! üì∏');
    }

    function openGallery() {
      const galleryModal = document.getElementById('galleryModal');
      const galleryContent = document.getElementById('galleryContent');
      
      if (capturedPhotos.length === 0) {
        galleryContent.innerHTML = `
          <div class="gallery-empty">
            <div class="gallery-empty-icon">üì∑</div>
            <div class="gallery-empty-text">No photos yet. Start capturing!</div>
          </div>
        `;
      } else {
        galleryContent.innerHTML = capturedPhotos.map(photo => `
          <div class="gallery-item" data-id="${photo.id}">
            <img src="${photo.dataUrl}" alt="Photo ${photo.timestamp}">
          </div>
        `).join('');
        
        // Add click listeners for download
        document.querySelectorAll('.gallery-item').forEach(item => {
          item.addEventListener('click', () => {
            const photoId = parseInt(item.dataset.id);
            const photo = capturedPhotos.find(p => p.id === photoId);
            if (photo) {
              const link = document.createElement('a');
              link.download = `DigiCam_${photo.timestamp}.jpg`;
              link.href = photo.dataUrl;
              link.click();
              showToast('Photo downloaded! üíæ');
            }
          });
        });
      }
      
      galleryModal.classList.add('show');
    }

    function closeGallery() {
      document.getElementById('galleryModal').classList.remove('show');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    function updateResolutionBadge() {
      const width = videoElement.videoWidth;
      const height = videoElement.videoHeight;
      const badge = document.getElementById('resolutionBadge');
      
      if (width >= 1920) {
        badge.textContent = 'FHD';
      } else if (width >= 1280) {
        badge.textContent = 'HD';
      } else {
        badge.textContent = 'SD';
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a889b5e9495ce9b',t:'MTc2NDgyMzAyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
